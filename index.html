<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>知識の水槽｜遊びながら知が泳ぐ</title>
<meta name="description" content="海のように広がる知識を、検索とタグでサッと探索。スマホ最適のカード一覧で学べます。">
<meta name="theme-color" content="#f0f6ff">
<meta property="og:title" content="知識の水槽">
<meta property="og:description" content="海のように広がる知識を、検索とタグでサッと探索。スマホ最適のカード一覧で学べます。">
<meta property="og:url" content="https://haisuikounozarigani.github.io/quiz/">
<meta property="og:image" content="https://haisuikounozarigani.github.io/quiz/assets/hero/t01.webp">
<link rel="preload" as="image" href="/quiz/assets/hero/t01.webp">
<style>
:root{
  /* ── 青ベース（心の標本と同構成） ── */
  --bg1:#f6fbff; --bg2:#eef4ff; --card:#fff; --line:#dbe8ff; --fg:#1f2a3a; --muted:#5b6a75;
  --accent:#4aa8ff; --accent2:#a48bff; --chip:#eaf3ff; --chipb:#dfe8ff;
}
*{box-sizing:border-box} html,body{height:100%} html{-webkit-text-size-adjust:100%;text-size-adjust:100%}
body{margin:0;color:var(--fg);font-family:"Noto Sans JP",system-ui,sans-serif;background:linear-gradient(160deg,var(--bg1),var(--bg2))}
.hidden{display:none!important}

/* Splash */
.splash{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;overflow:hidden;cursor:pointer}
.splash::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,.55) 70%,rgba(255,255,255,.8))}
.splash .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.05)}
.splash .fallback{position:absolute;inset:0;background:radial-gradient(1200px 600px at 50% 30%, #e9f4ff, #eef0ff)}
.splash .hero{position:relative;z-index:1;text-align:center;padding:22px}
h1{margin:0 0 6px;font-size:clamp(22px,6vw,34px);letter-spacing:.02em;text-wrap:balance}
.sub{margin:0;color:var(--muted)}
.tap{margin-top:14px;font-size:.95em;color:#6a7580}
.splash.closing{opacity:0;transition:opacity .28s ease;pointer-events:auto}

/* Main */
.wrap{max-width:980px;margin:20px auto 28px;padding:0 14px max(28px,env(safe-area-inset-bottom));opacity:0;transform:translateY(12px);transition:opacity .35s ease,transform .35s ease}
.wrap.show{opacity:1;transform:none}

/* Controls */
.controls{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:6px 0 10px;box-shadow:0 8px 22px rgba(74,168,255,.10)}
.controls .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input[type="search"]{flex:1;padding:12px 14px;border:1px solid #cfe2ff;border-radius:12px;font-size:16px}
.btn{appearance:none;border:1px solid #cfe2ff;background:#fff;border-radius:12px;padding:10px 12px;font-size:14px;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent;color:#fff}
.btn:focus-visible, .chip:focus-visible{outline:3px solid #98bfff;outline-offset:2px}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chip{padding:8px 12px;border:1px solid #cfe2ff;border-radius:999px;background:var(--chip);cursor:pointer;user-select:none;color:#234;line-height:1.2}
.chip.active{background:var(--chipb);box-shadow:inset 0 0 0 2px #7aa7ff;border-color:transparent}

/* Switcher */
.switcher{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.segbtn{
  appearance:none;border:1px solid #cfe2ff;background:#fff;border-radius:999px;
  padding:10px 14px;font-size:14px;line-height:1;text-decoration:none;color:inherit;
  display:inline-flex;align-items:center;gap:8px;min-height:44px
}
.segbtn.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(74,168,255,.18)}

/* Cards */
.links{display:grid;gap:12px;margin-top:10px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
a.link{
  display:flex;gap:10px;align-items:center;text-decoration:none;color:var(--fg);
  background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px 14px;
  box-shadow:0 6px 18px rgba(74,168,255,.12);transition:transform .12s ease,box-shadow .12s ease,border-color .12s ease
}
a.link:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(164,139,255,.18);border-color:#d7e6ff}
a.link .emo{display:inline-flex;width:28px;height:28px;align-items:center;justify-content:center;font-size:22px;line-height:1;flex:0 0 auto}
a.link > div{flex:1 1 auto;min-width:0}
.ttl{
  font-weight:800;margin:0;display:block;line-height:1.35;letter-spacing:.01em;text-wrap:balance;
  font-size:clamp(15px,3.8vw,17px);
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden
}
.mini{font-size:.72em;padding:2px 6px;border-radius:8px;border:1px solid #dfe7ff;background:#fff;display:inline-flex;align-items:center;line-height:1;vertical-align:middle;white-space:nowrap}
.mini.new{background:linear-gradient(90deg,#d6ebff,#e0dbff);color:#2b3b4a;border-color:transparent}
.sub2{
  color:var(--muted);font-size:.92em;margin:4px 0 0;line-height:1.5;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden
}
.meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.pill{padding:4px 8px;border-radius:999px;font-size:.8em;border:1px solid #dbe8ff;background:#fff;color:#3b4d5e;display:inline-flex;align-items:center;line-height:1;vertical-align:middle}
.badge{margin-left:auto;padding:8px 12px;border-radius:999px;font-weight:700;font-size:.9em;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;display:inline-flex;align-items:center;line-height:1;vertical-align:middle}

/* Footer */
.note{color:var(--muted);text-align:center;margin:18px 0}
.footerbar{position:sticky;bottom:0;display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;padding:10px;background:rgba(255,255,255,.82);
  backdrop-filter:blur(6px) saturate(1.05);border-top:1px solid #e6eefb}
.footerbar a{padding:12px 14px;border:1px solid #dbe8ff;border-radius:999px;text-decoration:none;color:#14202b;background:#fff;cursor:pointer;flex:0 0 auto;white-space:nowrap;line-height:1;display:inline-flex;align-items:center;min-height:44px}

@media (max-width:400px){
  .links{grid-template-columns:1fr}
  a.link{padding:12px}
  .badge{display:none}
}

/***** Quiz view counter (inline stats) *****/
.stats-inline{justify-content:flex-end;gap:10px;margin-top:6px;display:flex;flex-wrap:wrap}
.stats-inline .mini{
  color:var(--muted);font-size:.9em;
  border:1px solid var(--line);border-radius:999px;
  padding:4px 8px;background:#fff;line-height:1.6
}

/* === ランクボックス（心の標本と同形式） === */
.rankbox{
  margin:12px 0 8px; padding:12px;
  border:1px solid var(--line); border-radius:12px; background:#fff;
  box-shadow:0 1px 0 #f2e6f0;
}
.rankbox.pop{animation:rk-pop .5s}
@keyframes rk-pop{0%{transform:scale(.98)}50%{transform:scale(1.01)}100%{transform:scale(1)}}
.rk-head{display:flex;align-items:center;gap:8px}
.rk-emo{font-size:1.25em}
.rk-name{font-weight:700}
.rk-pct{margin-left:auto;color:var(--muted);font-size:.9em}
.rk-bar{height:10px;border-radius:999px;background:#f6edf5;border:1px solid #eed8ea;overflow:hidden;margin:8px 0}
.rk-bar #rkFill{display:block;height:100%;width:0;background:#dfe3ff;transition:width .4s, filter .2s}
.rk-next{font-size:.9em;color:#7b6571}

/* --- done marker（既に受けた表示：済バッジ） --- */
a.link[data-done]{position:relative;opacity:.9}
a.link[data-done]::after{
  content:"済"; position:absolute; top:8px; right:8px;
  font-weight:800; font-size:.8rem; line-height:1;
  padding:4px 8px; border-radius:999px;
  background:linear-gradient(90deg,#c3ffd6,#d8eaff);
  color:#233; border:1px solid #dce9f0; box-shadow:0 3px 10px rgba(0,0,0,.06)
}
/* 済カードではNEWバッジ隠す */
a.link[data-done] .mini[data-new]{display:none}
</style>
</head>
<body>

<!-- Splash -->
<section id="splash" class="splash" aria-label="知識の水槽の入口" tabindex="0" role="button">
  <div class="fallback" aria-hidden="true"></div>
  <img class="bg" alt="知識の水槽のキービジュアル"
       src="/quiz/assets/hero/t01.webp"
       onerror="this.src='/quiz/assets/hero/01.png'">
  <div class="hero">
    <h1>知識の水槽</h1>
    <p class="sub">タップ（またはEnter/Space）で入口が開きます。</p>
  </div>
</section>

<main id="content" class="wrap" aria-live="polite" aria-label="知識の入口" tabindex="-1" inert>
  <!-- Controls -->
  <section class="controls" aria-label="検索とタグ">
    <!-- サイト切替：現在ページを強調 -->
    <div class="row switcher" aria-label="サイト切替">
      <a class="segbtn" href="/shindan/" rel="noopener">🌟 心の標本</a>
      <a class="segbtn active" href="/quiz/" aria-current="page">🔎 知識の水槽</a>
    </div>

    <div class="row">
      <input id="q" type="search" placeholder="キーワード or #タグ（例：#海 / #心理）" aria-label="検索">
      <button id="btnNew" class="btn" type="button" aria-pressed="false" aria-label="未挑戦だけ表示">未挑戦だけ</button>
      <button id="clearBtn" class="btn" type="button" aria-label="検索とタグをクリア">クリア</button>
    </div>
    <div id="chips" class="chips" role="listbox" aria-multiselectable="false" aria-label="タグ（1つ選択で絞り込み）"></div>

    <!-- ローカル＋全体の「知識Lv」 -->
    <div class="row stats-inline" aria-label="水槽カウンタ">
      <span class="mini">📘 あなたの知識Lv <strong id="myOpenCount">0</strong></span>
      <span class="mini">📚 みんなの知識Lv <strong id="allOpenCount">—</strong></span>
    </div>
  </section>
  
  <!-- ★ 進捗ランク（コンプリート率） -->
  <section id="rankbox" class="rankbox" aria-live="polite">
    <div class="rk-head">
      <span id="rkEmoji" class="rk-emo" aria-hidden="true">🔹</span>
      <strong id="rkName" class="rk-name">水晶</strong>
      <span class="rk-pct"><span id="rkPct">0</span>%</span>
    </div>

    <div class="rk-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="コンプリート進捗">
      <span id="rkFill"></span>
    </div>

    <div id="rkNext" class="rk-next">あと <span id="rkRemain">1</span> 件でランクアップ</div>
  </section>

  <!-- Cards（クイズカード） -->
  <nav class="links" id="list" aria-label="記事/クイズ一覧（検索結果）">
    <!-- 以下、既存カード群はそのまま。例として3件だけ置いています（あなたの現行をここに全貼りでOK） -->
    	
    <!-- NEW: 秋の読書クイズ -->
<a class="link" href="/quiz/aki-reading.html"
   data-id="aki-reading" data-tags="クイズ,読書,心理,生活" data-mins="6"
   data-updated="2025-10-10"
   data-keywords="メラトニン 発光端末 E-ink ダークモード BGM 器楽 ノンカフェイン カフェ ノイズ 速読 RSVP フィクション 共感 正直 認知 学力 ボランティア">
  <span class="emo">📚</span>
  <div class="body">
    <div class="ttl">秋の読書クイズ</div>
    <div class="sub2">選ぶとすぐ判定。くすっと一言＋解説が出るA/B/C×15問。</div>
    <div class="meta"></div>
  </div>
  <span class="badge" data-new>NEW</span>
</a>

  <!-- NEW: 秋の食欲クイズ -->
<a class="link" href="/quiz/aki-appetite.html"
   data-id="aki-appetite" data-tags="クイズ,秋,生活,食欲" data-mins="6"
   data-updated="2025-10-02"
   data-keywords="超加工食品 マインドフル テトリス 睡眠不足 青色照明 たんぱく質 硬い食感 BGM ながら食べ 皿 ビュッフェ 酢 水 前菜 辛さ カトラリー アルコール 姿勢 写真撮影">
  <span class="emo">🍽️</span>
  <div class="body">
    <div class="ttl">秋の食欲クイズ</div>
    <div class="sub2">“増える/変わらない/減る”を見抜く3択×20問。選ぶとすぐ判定＆一言解説。</div>
    <div class="meta"></div>
  </div>
  <span class="badge" data-new>NEW</span>
</a>

    <!-- NEW: 秋の贅沢クイズ -->
    <a class="link" href="/quiz/aki-mix.html"
       data-id="aki-mix" data-tags="クイズ,秋,雑学,心理,行事,食" data-mins="5"
       data-updated="2025-09-24"
       data-keywords="紅葉 中秋の名月 ハロウィン サンマ 焼き芋 栗 カーディガン 読書 錯視 スポーツの秋">
      <span class="emo">🍁</span>
      <div class="body">
        <div class="ttl">秋の贅沢クイズ</div>
        <div class="sub2">“秋あるある”を楽しく更新。選んだ瞬間に判定される3択×15問。</div>
        <div class="meta"></div>
      </div>
      <span class="badge" data-new>NEW</span>
    </a>

    <!-- NEW: 猫と犬の心理研究クイズ -->
    <a class="link" href="/quiz/inu-neko-quiz.html"
       data-id="inu-neko-quiz" data-tags="クイズ,心理,猫,犬" data-mins="3"
       data-updated="2025-09-21"
       data-keywords="犬派 猫派 性格 オキシトシン 名前 指差し しっぽ 瞬き 散歩">
      <span class="emo">🐾</span>
      <div class="body">
        <div class="ttl">猫と犬の心理研究クイズ</div>
        <div class="sub2">選んだ瞬間に結果が出る、直感と研究のズレを楽しむ10問。</div>
        <div class="meta"></div>
      </div>
      <span class="badge" data-new>NEW</span>
    </a>

    <!-- 既存：作成中 -->
    <a class="link" href="#" aria-disabled="true"
       data-id="wip" data-tags="海" data-updated="2025-09-15"
       data-keywords="作成中 WIP 準備中">
      <span class="emo">🔧</span>
      <div class="body">
        <div class="ttl">作成中</div>
        <div class="sub2">コンテンツ公開まで少々お待ちください。</div>
        <div class="meta"></div>
      </div>
      <span class="badge">準備中</span>
    </a>
  </nav>

  <section id="legal-note" role="note" aria-label="ご利用にあたって" class="note">
    <h2 style="font-size:1.05em;margin:18px 0 10px">ご利用にあたって</h2>
    <ul style="margin:0 0 10px 18px;padding:0;line-height:1.7">
      <li><strong>非提携・非公式：</strong>本サイトの各コンテンツ（記事・クイズ等）は研究一般の知見に<span style="white-space:nowrap">ヒントを得た</span><strong>独自制作</strong>です。各種の公式検査・尺度の<strong>原文項目や正式な採点方法は使用しておらず</strong>、権利者の承認・提携・推奨を意味しません。</li>
      <li><strong>医療用途ではありません：</strong>娯楽＋自己理解の目安を目的とした読み物/セルフチェックで、医療的・心理的な<strong>診断／治療／助言を目的としません</strong>。強い苦痛や不調が続く場合は、医療機関や専門家へご相談ください。</li>
      <li><strong>プライバシー：</strong>ページ内のインタラクションは<strong>ブラウザ内（端末内）で完結</strong>し、サーバーへの送信は行いません。進行状況や一部表示設定のみローカルストレージに保存されることがあります。</li>
      <li><strong>表現について：</strong>「タイプ」「サイコパス」等の呼称は<strong>比喩・俗称・ゲーミフィケーション表現</strong>であり、他者を断定・ラベリングする用途を意図しません。</li>
      <li><strong>免責：</strong>法令で認められる範囲で、本サイトの利用により生じたいかなる損失・損害についても、当サイトは責任を負いません。</li>
    </ul>
  </section>
</main>

<!-- Footer -->
<nav class="footerbar" aria-label="フッターナビ">
  <a href="https://x.com/oki2a?s=21" target="_blank" rel="noopener">X</a>
  <a href="https://www.instagram.com/zariganitabetai7?igsh=MTdzc245MDJrdWZzYw%3D%3D&utm_source=qr" target="_blank" rel="noopener">Instagram</a>
  <a href="https://line.me/ti/p/JO0O0lvpKY" target="_blank" rel="noopener">LINE</a>
  <a href="/shindan/seikaku.html">自己紹介</a>
</nav>

<noscript>
  <div style="max-width:980px;margin:16px auto;padding:0 14px max(28px,env(safe-area-inset-bottom));color:#6b7b86">
    JavaScriptが無効です。<a href="/quiz/">一覧はこちら</a>。
  </div>
</noscript>

<script>
(function(){
  const $  = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>[...root.querySelectorAll(q)];

  const splash  = $('#splash');
  const content = $('#content');
  const vibrate = (ms=10)=>('vibrate' in navigator)&&navigator.vibrate(ms);

  // Splash open
  const GUARD_MS=600, HIDE_DELAY=300; let opened=false, guardUntil=0;
  function startClickGuard(){
    guardUntil=performance.now()+GUARD_MS;
    const guard=(e)=>{ if(performance.now()<guardUntil){ e.stopPropagation(); e.preventDefault(); } else { window.removeEventListener('click',guard,true); } };
    window.addEventListener('click',guard,true);
    content.style.pointerEvents='none'; setTimeout(()=>{content.style.pointerEvents='';},GUARD_MS);
  }
  function reveal(ev){
    if(opened) return; opened=true;
    if(ev){ try{ ev.preventDefault(); ev.stopPropagation(); }catch{} }
    startClickGuard();
    splash.classList.add('closing'); splash.setAttribute('aria-hidden','true');
    content.classList.add('show'); vibrate(12);
    setTimeout(()=>{ splash.classList.add('hidden'); splash.classList.remove('closing'); try{ content.removeAttribute('inert'); content.focus({preventScroll:true}); }catch{} }, Math.max(HIDE_DELAY,GUARD_MS));
  }
  splash.addEventListener('pointerup', e=>{ if(e?.target?.closest?.('a,button,input,label')) return; reveal(e); });
  splash.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); reveal(e); } });

  // NEWバッジ（21日以内）
  const today=new Date();
  $$('#list a.link').forEach(a=>{
    const badge=a.querySelector('[data-new]'); const ds=a.dataset.updated;
    if(badge && ds){ const diff=(today - new Date(ds+'T00:00:00'))/86400000; badge.style.display=(diff<=21)?'inline-flex':'none'; }
  });

  // data-thumb → サムネ（未使用：data-thumbがあれば有効）
  $$('#list a.link').forEach(a=>{
    const src=a.dataset.thumb; if(!src) return;
    a.classList.add('with-thumb');
    const fg=document.createElement('figure'); fg.className='thumb';
    const img=new Image(); img.loading='lazy'; img.src=src; img.alt=(a.querySelector('.ttl')?.textContent||'記事')+'のサムネイル';
    fg.appendChild(img); a.insertBefore(fg,a.firstChild);
  });

  // 検索・タグ（単一選択）
  const q=$('#q'), chipsWrap=$('#chips'), btnNew=$('#btnNew'), clearBtn=$('#clearBtn');

  // 「未挑戦だけ」トグル
  let todoOnly=false;
  btnNew.addEventListener('click', ()=>{
    todoOnly=!todoOnly;
    btnNew.classList.toggle('primary',todoOnly);
    btnNew.setAttribute('aria-pressed', String(todoOnly));
    btnNew.textContent = todoOnly ? '未挑戦だけ（解除）' : '未挑戦だけ';
    apply();
  });

  // エイリアス・タグ順
  const ALIAS={ '性格':'こころ', '短時間':'さくっと' };
  const ORDER=['海','心理','脳','生活','クイズ','診断','こころ','セルフケア','認知','仕事','占い','ゲーム風','さくっと','ふつう','しっかり','適性'];

  // カードのタグ正規化 + メタ整形
  $$('#list a.link').forEach(a=>{
    const tags=(a.dataset.tags||'').split(',').map(s=>s.trim()).filter(Boolean).map(t=>ALIAS[t]||t);
    a.dataset.tags=[...new Set(tags)].join(',');
    const meta=a.querySelector('.meta'); meta.innerHTML='';
    const mins=a.dataset.mins; if(mins){ const s=document.createElement('span'); s.className='pill'; s.textContent=`⏱${mins}分`; meta.appendChild(s); }
  });

  // タグ候補（存在するもののみ）
  const counts={};
  $$('#list a.link').forEach(a=>{
    (a.dataset.tags||'').split(',').filter(Boolean).forEach(t=>{ counts[t]=(counts[t]||0)+1; });
  });
  const tagsSorted=Object.keys(counts).sort((a,b)=>{
    const ai=ORDER.indexOf(a), bi=ORDER.indexOf(b);
    if(ai!==-1 || bi!==-1){ return (ai===-1?999:ai) - (bi===-1?999:bi); }
    return a.localeCompare(b,'ja');
  });

  // チップ生成（単一選択）
  let activeTag=null; const chipMap=new Map();
  tagsSorted.forEach(tag=>{
    const b=document.createElement('button');
    b.type='button'; b.className='chip'; b.textContent='#'+tag; b.dataset.tag=tag;
    b.setAttribute('role','option'); b.setAttribute('aria-selected','false');
    b.addEventListener('click',()=> setActiveTag(activeTag===tag? null : tag));
    b.addEventListener('keydown',e=>{
      if(e.key===' '||e.key==='Enter'){ e.preventDefault(); b.click(); }
      if(e.key==='ArrowRight'||e.key==='ArrowLeft'){
        e.preventDefault(); const chips=[...chipsWrap.querySelectorAll('.chip')];
        const i=chips.indexOf(document.activeElement); if(i>-1){ chips[(i+(e.key==='ArrowRight'?1:-1)+chips.length)%chips.length].focus(); }
      }
    });
    chipsWrap.appendChild(b); chipMap.set(tag,b);
  });

  function setActiveTag(tag){
    activeTag=tag;
    chipMap.forEach((btn,t)=>{ const on=(t===tag); btn.classList.toggle('active',on); btn.setAttribute('aria-selected',on?'true':'false'); });
    if(tag){ history.replaceState({},'', '#tag='+encodeURIComponent(tag)); } else { history.replaceState({},'', location.pathname + location.search); }
    apply();
  }

  // 初期：#tag= or ?q=
  const params=new URLSearchParams(location.search);
  q.value=params.get('q')||'';
  const initTag=location.hash.startsWith('#tag=') ? decodeURIComponent(location.hash.slice(5)) : '';
  if(initTag && chipMap.has(initTag)) setActiveTag(initTag);

  // 入力：末尾 #タグ を同期
  q.addEventListener('input', ()=>{
    const m=q.value.match(/(^|\s)#([^\s#]+)$/);
    if(m){ const t=m[2]; if(chipMap.has(t)) setActiveTag(t); }
    apply();
  });

  // クリア
  clearBtn.addEventListener('click', ()=>{
    q.value=''; setActiveTag(null);
    if(location.hash) history.replaceState({},'', location.pathname + location.search);
    apply();
  });

  // 済マーク復元（心の標本と同仕様）
  const LS_BYID_KEY = "quiz:open:byid";
  function getDoneMap(){ try{ return JSON.parse(localStorage.getItem(LS_BYID_KEY)||"{}"); }catch(e){ return {}; } }
  function markDoneCards(){
    const done = getDoneMap();
    document.querySelectorAll('#list a.link').forEach(a=>{
      const id=a.dataset.id; if(!id) return;
      if(done[id]>0) a.setAttribute('data-done','1'); else a.removeAttribute('data-done');
    });
  }
  window.markDoneCards = markDoneCards;

  // 進捗ランク
  let lastRankName = null;
  function updateCompletion(){
    const cards = document.querySelectorAll('#list a.link');
    const total = cards.length;
    let doneMap = getDoneMap();
    let done = 0;
    cards.forEach(a=>{ const id=a.dataset.id; if(id && doneMap[id]>0) done++; });
    const pct = total ? Math.round(done/total*100) : 0;

    const ranks = [
      {min:  0, name:'水晶',        emo:'🔹', grad:'linear-gradient(90deg,#8fd3ff,#c9c9ff)'},
      {min: 10, name:'銅',          emo:'🥉', grad:'linear-gradient(90deg,#d68b49,#ffd29d)'},
      {min: 25, name:'銀',          emo:'🥈', grad:'linear-gradient(90deg,#aeb6bf,#e6eef5)'},
      {min: 45, name:'金',          emo:'🥇', grad:'linear-gradient(90deg,#f2c94c,#f2994a)'},
      {min: 70, name:'白金',        emo:'✨', grad:'linear-gradient(90deg,#d6d0ff,#ffffff)'},
      {min: 90, name:'ダイヤモンド', emo:'💎', grad:'linear-gradient(90deg,#8be9ff,#b69cff)'}
    ];

    let cur = ranks[0]; for(const r of ranks){ if(pct>=r.min) cur=r; }
    const next = ranks.find(r=>r.min>pct);

    const box   = document.getElementById('rankbox');
    const emo   = document.getElementById('rkEmoji');
    const name  = document.getElementById('rkName');
    const fill  = document.getElementById('rkFill');
    const pctEl = document.getElementById('rkPct');
    const nextEl= document.getElementById('rkNext');
    if(!box||!emo||!name||!fill||!pctEl||!nextEl) return;

    emo.textContent   = cur.emo;
    name.textContent  = cur.name;
    pctEl.textContent = pct;
    fill.style.width  = pct + '%';
    fill.style.background = cur.grad;
    fill.style.filter = 'drop-shadow(0 0 6px rgba(255,255,255,.5))';

    if(next){
      const needDone = Math.ceil((next.min/100)*total);
      const remain   = Math.max(0, needDone - done);
      nextEl.innerHTML = 'あと <span id="rkRemain">'+remain+'</span> 件でランクアップ';
    }else{
      nextEl.textContent = 'コンプリート間近！ 予備の新作を鋭意制作中。';
    }

    if(lastRankName!==null && lastRankName!==cur.name){
      box.classList.remove('pop'); void box.offsetWidth; box.classList.add('pop');
    }
    lastRankName = cur.name;
  }
  window.updateCompletion = updateCompletion;

  // フィルタ本体
  function apply(){
    const kw=q.value.trim().toLowerCase().split(/\s+/).filter(Boolean).filter(t=>!t.startsWith('#'));
    let shown=0;
    $$('#list a.link').forEach(a=>{
      const tags=(a.dataset.tags||'').split(',').filter(Boolean);
      const text=(a.textContent+' '+(a.dataset.keywords||'')).toLowerCase();
      const okTag  = activeTag ? tags.includes(activeTag) : true;
      const okKw   = kw.length ? kw.every(w=>text.includes(w)) : true;
      const okTodo = todoOnly ? !a.hasAttribute('data-done') : true;
      const show   = okTag && okKw && okTodo;
      a.style.display=show?'':'none'; if(show) shown++;
    });
    $('#list').setAttribute('aria-label', `記事/クイズ一覧（検索結果 ${shown} 件）`);
    updateCompletion();
  }

  // 初期反映
  markDoneCards();
  updateCompletion();
  apply();

  // 他タブ同期
  window.addEventListener('storage', (e)=>{
    if(e.key===LS_BYID_KEY){
      markDoneCards();
      updateCompletion();
      apply();
    }
  });

  // Escで検索クリア
  document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ q.value=''; setActiveTag(null); apply(); } });

  // 「済」更新後に再フィルタできるようイベント待ち受け
  document.addEventListener('quiz-done', apply);

  // 祝砲KF（無ければ追加）
  (function addFadeUpKeyframes(){
    const id='rkFadeUpKF';
    if(document.getElementById(id)) return;
    const st=document.createElement('style'); st.id=id;
    st.textContent=`@keyframes fadeUp{0%{opacity:0;transform:translateY(6px) scale(.95)}60%{opacity:1}100%{opacity:.0;transform:translateY(-8px) scale(1.1)}}`;
    document.head.appendChild(st);
  })();
})();
</script>

<!-- ▼ クイズ閲覧カウンタ（心の標本と同方式：クリックで加算＋済化） -->
<script>
(function(){
  const myEl  = document.querySelector('#myOpenCount');
  const allEl = document.querySelector('#allOpenCount');

  // —— 設定（必要ならURLだけ差し替え） ——
  const CF_WORKER_URL = "https://counter.asagikarin.workers.dev"; // 心と同じでOK
  const GLOBAL_KEY    = "quiz_open_total"; // クイズ用・全体キー名

  // LocalStorage keys（クイズ用）
  const LS_TOTAL_KEY   = "quiz:open:total";
  const LS_BYID_KEY    = "quiz:open:byid";
  const LS_GLOBAL_LAST = "quiz:open:global:last";

  // 表示ヘルパ
  function setAll(val){
    if(!allEl) return;
    if (typeof val === "number" && Number.isFinite(val)) {
      allEl.textContent = val.toLocaleString("ja-JP");
      try{ localStorage.setItem(LS_GLOBAL_LAST, String(val)); }catch(e){}
    } else {
      const last = parseInt(localStorage.getItem(LS_GLOBAL_LAST) || "0", 10);
      allEl.textContent = last ? last.toLocaleString("ja-JP") : "—";
    }
  }
  function getLocalTotal(){
    const n = parseInt(localStorage.getItem(LS_TOTAL_KEY) || "0", 10);
    return Number.isFinite(n) ? n : 0;
  }
  function setLocalTotal(n){ localStorage.setItem(LS_TOTAL_KEY, String(n)); }
  function incLocalById(id){
    const t = getLocalTotal() + 1;
    setLocalTotal(t);
    let map={}; try{ map=JSON.parse(localStorage.getItem(LS_BYID_KEY) || "{}"); }catch(e){}
    map[id]=(map[id]||0)+1;
    localStorage.setItem(LS_BYID_KEY, JSON.stringify(map));
    if(myEl) myEl.textContent = t.toLocaleString("ja-JP");
  }

  // 全体取得
  async function getGlobalCount(){
    try{
      const url = new URL(CF_WORKER_URL);
      url.searchParams.set("key", GLOBAL_KEY);
      const r = await fetch(url.toString(), {mode:"cors", cache:"no-store"});
      const d = await r.json();
      return (d && typeof d.value === "number") ? d.value : null;
    }catch(e){ return null; }
  }

  // 全体+1（GET/keepalive）
  function bumpGlobal(){
    try{
      const url = new URL(CF_WORKER_URL);
      url.searchParams.set("key", GLOBAL_KEY);
      url.searchParams.set("hit", "1");
      fetch(url.toString(), { mode:"cors", cache:"no-store", keepalive:true }).catch(()=>{});
    }catch(e){}
  }

  // 初期表示
  if(myEl) myEl.textContent = getLocalTotal().toLocaleString("ja-JP");
  setAll(null); // まず前回値/—を表示
  getGlobalCount().then(val => setAll(val)).catch(()=>setAll(null));

  // 一覧クリックで計測（遷移前）
  const list = document.querySelector('#list');
  if(list){
    list.addEventListener('click', function(e){
      const a = e.target.closest('a.link');
      if(!a) return;
      const id = a.dataset.id || "unknown";
      incLocalById(id);      // あなたの知識Lv +1
      bumpGlobal();          // みんなの知識Lv +1
      // 済バッジ付与＋ランク更新＋表示再適用
      try{ a.setAttribute('data-done','1'); }catch(_){}
      if (window.updateCompletion) window.updateCompletion();
      document.dispatchEvent(new CustomEvent('quiz-done'));
      // 楽観更新（チラつき防止）
      const cur = parseInt(localStorage.getItem(LS_GLOBAL_LAST) || "0", 10) || 0;
      setAll(cur + 1);
    }, {capture:true});
  }
})();
</script>

</body>
</html>
